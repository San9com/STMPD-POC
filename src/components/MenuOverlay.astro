---
import LogoMark from "./LogoMark.astro";
import IconMenu from "./IconMenu.astro";

/**
 * Menu state based on Figma `Frame 2` (id: 949:1271).
 * Rendered as a fixed overlay and toggled by `data-menu-open` on <html>.
 *
 * Behavior: open from any `[data-menu-open]` trigger; close on backdrop, close button,
 * ESC, and when clicking any menu link (prototype-like).
 */
const BASE_URL = import.meta.env.BASE_URL;
const withBase = (p = "") => `${BASE_URL}${String(p).replace(/^\/+/, "")}`;
const path = Astro.url?.pathname || "/";
const isHome = path === BASE_URL || path === BASE_URL.replace(/\/$/, "") || path === "/";
const sectionHref = (id) => (isHome ? `#${id}` : `${BASE_URL}#${id}`);

const photos = {
  studios: withBase("assets/Rectangle 9.png"),
  people: withBase("assets/274082823_1471205146649880_25528948957257731_n.jpg"),
  machines: withBase("assets/489833225_18358745860181286_4041526710478678309_n.jpg"),
  film: withBase("assets/Rectangle 9-2.png"),
  contact: withBase("assets/home.png"),
};
---

<aside
  id="menu"
  class="fixed inset-0 z-50"
  data-menu-overlay
  aria-hidden="true"
>
  <!-- Backdrop -->
  <button
    type="button"
    class="absolute inset-0 bg-black/30"
    aria-label="Close menu"
    data-menu-backdrop
    data-menu-close
  ></button>

  <!-- Panel -->
  <div
    class="absolute right-0 top-0 h-full w-full max-w-[1512px] bg-white text-ink shadow-2xl"
    data-menu-panel
  >
    <!-- Overlay header: match Home header geometry so the center logo doesn't jump -->
    <div class="pointer-events-auto mx-auto max-w-[1512px] px-6 pt-6 lg:px-0 lg:pt-[57px]">
      <!-- Mobile: keep it clean -->
      <div class="flex items-center justify-between text-ink lg:hidden">
        <button
          type="button"
          aria-label="Close menu"
          data-menu-open
          class="grid h-[44px] w-[44px] place-items-center text-ink transition-colors hover:text-[#CB530E] focus-visible:text-[#CB530E]"
        >
          <IconMenu class="h-[14px] w-[46px]" color="currentColor" />
        </button>
        <a href={BASE_URL} aria-label="STMPD" class="grid h-[58px] w-[51px] place-items-center">
          <LogoMark class="h-[58px] w-[51px]" variant="black" alt="" />
        </a>
        <div class="h-[44px] w-[44px]" aria-hidden="true"></div>
      </div>

      <!-- Desktop: exact positions from Home header -->
      <header class="relative hidden h-[57px] w-[953px] lg:block" style="margin-left:261.535px;">
        <div class="relative h-full w-full text-ink">
          <button
            type="button"
            class="absolute left-[0px] top-[23px] h-[14px] w-[46px] text-ink transition-colors hover:text-[#CB530E] focus-visible:text-[#CB530E]"
            aria-label="Close menu"
            data-menu-open
          >
            <IconMenu class="h-[14px] w-[46px]" color="currentColor" />
          </button>

          <a href={BASE_URL} class="absolute left-[470px] top-0 h-[57px] w-[50px]" aria-label="STMPD">
            <LogoMark class="h-[57px] w-[50px]" variant="black" alt="" />
          </a>
        </div>
      </header>
    </div>

    <div class="relative mx-auto w-full px-6 pb-10 pt-10 lg:px-[71px] lg:pt-[47px]">
      <!-- Hover cursor photo (desktop only): section preview image -->
      <div class="menu-hover-badge" aria-hidden="true">
        <img
          id="menuHoverPhoto"
          src={photos.studios}
          alt=""
          loading="eager"
          decoding="async"
          draggable="false"
        />
      </div>

      <nav data-menu-list>
        <!-- Desktop matches Figma scale; smaller screens use clamp for elegant scaling -->
        <a
          href={sectionHref("studios")}
          data-menu-item="studios"
          class="block font-pastiche text-[clamp(64px,10vw,188px)] leading-[clamp(64px,8vw,150px)] text-ink transition-colors hover:text-[#CB530E] focus-visible:text-[#CB530E]"
          >Studios</a
        >
        <div class="h-px w-full bg-black"></div>

        <a
          href={sectionHref("people")}
          data-menu-item="people"
          class="block font-pastiche text-[clamp(64px,10vw,188px)] leading-[clamp(64px,8vw,150px)] text-ink-2 transition-colors hover:text-[#CB530E] focus-visible:text-[#CB530E]"
          >People</a
        >
        <div class="h-px w-full bg-black"></div>

        <a
          href={sectionHref("machines")}
          data-menu-item="machines"
          class="block font-pastiche text-[clamp(64px,10vw,188px)] leading-[clamp(64px,8vw,150px)] text-ink-2 transition-colors hover:text-[#CB530E] focus-visible:text-[#CB530E]"
          >Machines</a
        >
        <div class="h-px w-full bg-black"></div>

        <a
          href={sectionHref("film")}
          data-menu-item="film"
          class="block font-pastiche text-[clamp(64px,10vw,188px)] leading-[clamp(64px,8vw,150px)] text-ink-2 transition-colors hover:text-[#CB530E] focus-visible:text-[#CB530E]"
          >Film</a
        >
        <div class="h-px w-full bg-black"></div>

        <a
          href={sectionHref("contact")}
          data-menu-item="contact"
          class="block font-pastiche text-[clamp(64px,10vw,188px)] leading-[clamp(64px,8vw,150px)] text-ink-2 transition-colors hover:text-[#CB530E] focus-visible:text-[#CB530E]"
          >Contact</a
        >
        <div class="h-px w-full bg-black"></div>
      </nav>
    </div>
  </div>
</aside>

<script is:inline define:vars={{ photoByType: photos }}>
  const overlay = document.querySelector("[data-menu-overlay]");
  const panel = document.querySelector("[data-menu-panel]");
  const openBtns = Array.from(document.querySelectorAll("[data-menu-open]"));
  const closeBtns = Array.from(document.querySelectorAll("[data-menu-close]"));
  let lastActive = null;

  function sync() {
    const open = document.documentElement.hasAttribute("data-menu-open");
    if (!overlay) return;
    overlay.setAttribute("aria-hidden", open ? "false" : "true");
    document.body.style.overflow = open ? "hidden" : "";
  }

  function open() {
    // Toggle: if already open, close (so the header icon can act as an X).
    if (document.documentElement.hasAttribute("data-menu-open")) {
      close();
      return;
    }

    lastActive = document.activeElement;
    document.documentElement.setAttribute("data-menu-open", "");
    sync();
    // Focus the close button for keyboard users (prototype feel).
    const firstClose = overlay?.querySelector("[data-menu-close]");
    firstClose?.focus?.();
  }

  function close() {
    document.documentElement.removeAttribute("data-menu-open");
    sync();
    // Restore focus to the opener when closing.
    if (lastActive && typeof lastActive.focus === "function") {
      lastActive.focus();
    }
    lastActive = null;
  }

  openBtns.forEach((btn) => btn.addEventListener("click", open));

  closeBtns.forEach((btn) => btn.addEventListener("click", close));

  // Close when clicking any menu link (prototype behavior).
  panel?.addEventListener("click", (e) => {
    const a = e.target?.closest?.("a[href]");
    if (a) close();
  });

  // Hover cursor badge (desktop only)
  const hoverWrap = document.querySelector(".menu-hover-badge");
  const hoverImg = document.getElementById("menuHoverPhoto");
  const list = document.querySelector("[data-menu-list]");
  let activeType = "studios";
  let raf = 0;
  let targetX = 0;
  let targetY = 0;
  let curX = 0;
  let curY = 0;
  let hasPointer = false;

  function setVisible(on) {
    if (!hoverWrap) return;
    hoverWrap.toggleAttribute("data-visible", !!on);
  }

  function setPos(x, y) {
    if (!hoverWrap) return;
    // small badge offset from cursor (so it doesn't sit directly under it)
    hoverWrap.style.transform = `translate3d(${Math.round(x + 18)}px, ${Math.round(y + 10)}px, 0)`;
  }

  function setPhoto(type) {
    if (!hoverImg) return;
    const next = photoByType[type] || photoByType.studios;
    if (hoverImg.getAttribute("src") !== next) hoverImg.setAttribute("src", next);
  }

  function tick() {
    raf = 0;
    if (!hoverWrap) return;
    if (!document.documentElement.hasAttribute("data-menu-open")) {
      setVisible(false);
      return;
    }
    if (!hasPointer) {
      setVisible(false);
      return;
    }

    // smooth follow
    curX += (targetX - curX) * 0.18;
    curY += (targetY - curY) * 0.18;
    setPos(curX, curY);
    setVisible(true);

    // keep animating while visible
    raf = requestAnimationFrame(tick);
  }

  function start() {
    if (!raf) raf = requestAnimationFrame(tick);
  }

  function stop() {
    if (raf) cancelAnimationFrame(raf);
    raf = 0;
  }

  function handleEnter(type) {
    if (window.matchMedia && window.matchMedia("(hover: none)").matches) return;
    activeType = type || "studios";
    setPhoto(activeType);
    start();
  }

  function handleLeave() {
    hasPointer = false;
    stop();
    setVisible(false);
  }

  list?.addEventListener("pointerover", (e) => {
    const item = e.target?.closest?.("[data-menu-item]");
    if (!item) return;
    handleEnter(item.getAttribute("data-menu-item") || "studios");
  });

  list?.addEventListener("pointerout", (e) => {
    const leavingList = !e.relatedTarget || !list.contains(e.relatedTarget);
    if (leavingList) handleLeave();
  });

  list?.addEventListener("pointermove", (e) => {
    if (!hoverWrap) return;
    if (window.matchMedia && window.matchMedia("(hover: none)").matches) return;
    hasPointer = true;
    targetX = e.clientX;
    targetY = e.clientY;
    if (!raf) {
      curX = targetX;
      curY = targetY;
      start();
    }
  });

  // also hide if the overlay closes
  document.addEventListener(
    "click",
    () => {
      if (!document.documentElement.hasAttribute("data-menu-open")) handleLeave();
    },
    { passive: true }
  );

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      close();
    }

    // Basic focus trap while open.
    if (e.key === "Tab" && document.documentElement.hasAttribute("data-menu-open") && panel) {
      const focusables = Array.from(
        panel.querySelectorAll(
          'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
        )
      ).filter((el) => el.offsetParent !== null);
      if (focusables.length === 0) return;
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      const active = document.activeElement;
      if (e.shiftKey && active === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && active === last) {
        e.preventDefault();
        first.focus();
      }
    }
  });

  // If something else toggles the attribute, reflect it immediately.
  new MutationObserver(sync).observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["data-menu-open"],
  });

  sync();
</script>

