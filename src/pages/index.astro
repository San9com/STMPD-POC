---
import BaseLayout from "../layouts/BaseLayout.astro";
import MenuOverlay from "../components/MenuOverlay.astro";
import IconMenu from "../components/IconMenu.astro";
import PillButton from "../components/PillButton.astro";
import LogoMark from "../components/LogoMark.astro";
import SiteFooter from "../components/SiteFooter.astro";
import fs from "node:fs/promises";

// Goal:
// - Match the Figma desktop layout at max-width 1512px
// - Reflow responsively below that (no full-page absolute positioning)

const RAW_BASE_URL = import.meta.env.BASE_URL;
const BASE_URL = RAW_BASE_URL.endsWith("/") ? RAW_BASE_URL : `${RAW_BASE_URL}/`;
const withBase = (p = "") => `${BASE_URL}${String(p).replace(/^\/+/, "")}`;

const mixTitleSvg = await fs.readFile(new URL("../../public/assets/mix-title.svg", import.meta.url), "utf-8");
const performTitleSvg = await fs.readFile(new URL("../../public/assets/perform-title.svg", import.meta.url), "utf-8");
const loungeTitleSvg = await fs.readFile(new URL("../../public/assets/Lounge-title.svg", import.meta.url), "utf-8");
const shareTitleSvg = await fs.readFile(new URL("../../public/assets/share-title.svg", import.meta.url), "utf-8");

const studios = [
  {
    title: "Studio 1",
    href: withBase("studio-1/"),
    kind: "video",
    src: withBase("assets/IMG_7365.MOV"),
    poster: withBase("assets/Rectangle 9.png"),
  },
  {
    title: "Studio 2",
    href: withBase("studio-2/"),
    kind: "video",
    src: withBase("assets/IMG_7367.MOV"),
    poster: withBase("assets/Rectangle 9.png"),
  },
  // Temporary repetition until we have real data for all studios
  {
    title: "Studio 1",
    href: withBase("studio-1/"),
    kind: "video",
    src: withBase("assets/IMG_7364.MOV"),
    poster: withBase("assets/Rectangle 9.png"),
  },
  {
    title: "Studio 2",
    href: withBase("studio-2/"),
    kind: "video",
    src: withBase("assets/IMG_7367.MOV"),
    poster: withBase("assets/Rectangle 9.png"),
  },
];

const videoType = (src) => {
  if (!src || typeof src !== "string") return undefined;
  const lower = src.toLowerCase();
  if (lower.endsWith(".mp4")) return "video/mp4";
  if (lower.endsWith(".webm")) return "video/webm";
  // For MOV (and unknown containers), omit `type` so the browser can sniff.
  return undefined;
};
---

<BaseLayout>
  <MenuOverlay />

  <main class="bg-white text-ink">
    <!-- HERO media -->
    <section class="relative">
      <div class="h-[220px] overflow-hidden bg-neutral-200 sm:h-[260px] lg:h-[331px]">
        <img
          src={withBase("assets/Rectangle 9.png")}
          alt=""
          class="absolute inset-0 h-full w-full object-cover"
          loading="eager"
          decoding="async"
          data-video-poster="hero"
        />
        <video
          class="absolute inset-0 h-full w-full object-cover"
          autoplay
          muted
          loop
          playsinline
          preload="metadata"
          poster={withBase("assets/Rectangle 9.png")}
          data-video="hero"
          onerror="this.remove()"
        >
          <source src={withBase("assets/IMG_7367.MOV")} type={videoType(withBase("assets/IMG_7367.MOV"))} />
        </video>
      </div>

      <!-- NAV: desktop matches Figma geometry, mobile uses a clean header -->
      <div class="pointer-events-none absolute inset-x-0 top-0">
        <div class="pointer-events-auto mx-auto max-w-[1512px] px-6 pt-6 lg:px-0 lg:pt-[57px]">
          <div class="flex items-center justify-between text-white lg:hidden">
            <button type="button" aria-label="Open menu" data-menu-open class="grid h-[44px] w-[44px] place-items-center">
              <IconMenu class="h-[14px] w-[46px]" color="#ffffff" />
            </button>
            <a href={BASE_URL} aria-label="STMPD" class="grid h-[58px] w-[51px] place-items-center">
              <LogoMark class="h-[58px] w-[51px]" alt="" />
            </a>
            <div class="h-[44px] w-[44px]" aria-hidden="true"></div>
          </div>

          <header class="relative hidden h-[57px] w-[953px] lg:block" style="margin-left:261.535px;">
            <nav class="relative h-full w-full text-white">
              <!-- Figma layout: hamburger → PEOPLE → (logo mark) → STUDIOS → CONTACT -->
              <button
                type="button"
                class="absolute left-[0px] top-[23px] h-[14px] w-[46px]"
                aria-label="Open menu"
                data-menu-open
              >
                <IconMenu class="h-[14px] w-[46px]" color="#ffffff" />
              </button>
              <a href="#people" class="marker-hover marker-hover--invert absolute left-[228px] top-[22px] text-[16px] font-light leading-[19.04px]">PEOPLE</a>
              <a href="#studios" class="marker-hover marker-hover--invert absolute left-[666px] top-[22px] text-[16px] font-light leading-[19.04px]">STUDIOS</a>
              <a href="#contact" class="marker-hover marker-hover--invert absolute left-[885px] top-[22px] text-[16px] font-light leading-[19.04px]">CONTACT</a>
              <a href={BASE_URL} class="absolute left-[470px] top-0 h-[57px] w-[50px]" aria-label="STMPD">
                <LogoMark class="h-[57px] w-[50px]" alt="" />
              </a>
            </nav>
          </header>
        </div>
      </div>
    </section>

    <!-- HERO typography -->
    <section class="mx-auto max-w-[1512px] px-6 pb-10 pt-10 lg:px-0 lg:pb-16">
      <div class="grid items-start gap-10 lg:grid-cols-[1fr_240px] lg:px-[113px]">
        <!-- Force 3-line layout at desktop width (matches your Figma intent) -->
        <h1 class="font-pastiche text-[clamp(64px,8vw,160px)] leading-[clamp(56px,6.5vw,104px)]">
          <span class="lg:block">your creative</span>
          <span class="lg:block">partner in</span>
          <span class="lg:block">sound</span>
        </h1>

        <!-- Upper right copy -->
        <div class="flex flex-col text-black lg:min-h-[312px] lg:pt-[20px]">
          <p class="text-[18px] leading-[21.42px] tracking-[0.36px]">
            <span class="text-[#CB530E]">STMPD STUDIOS</span> provides the most advanced music production, audio and immersive sound
          </p>
          <div class="mt-10 flex items-center justify-between lg:mt-auto">
            <p class="text-[18px] leading-[21.42px] tracking-[0.36px]">AMS BASED</p>
            <span class="h-[6px] w-[6px] bg-black"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- FEATURED: responsive grid, exact card sizes at desktop -->
    <section class="mx-auto max-w-[1512px] px-6 pb-16 lg:px-0">
      <div class="grid gap-6 sm:grid-cols-2 xl:grid-cols-4 xl:gap-[0px]">
        <!-- Card 1 (433×230) -->
        <article class="mx-auto w-full max-w-[433px] group" data-artist-card>
          <div class="h-[230px] w-full overflow-hidden bg-neutral-200 transition-[height] duration-500 [transition-timing-function:cubic-bezier(0.22,1,0.36,1)] group-hover:h-[311px]">
            <img src={withBase("assets/489833225_18358745860181286_4041526710478678309_n.jpg")} alt="" class="h-full w-full object-cover" />
          </div>
          <div class="mt-[26px] flex items-center justify-between text-[20px] leading-[23.8px] text-ink">
            <span class="font-extralight">Studio</span>
            <span class="font-medium">Session</span>
          </div>
        </article>

        <!-- Card 2 (433×311) -->
        <article class="mx-auto w-full max-w-[433px] group" data-artist-card>
          <!-- Match the other cards by default; expand smoothly on hover only -->
          <div class="h-[230px] w-full overflow-hidden bg-neutral-200 transition-[height] duration-500 [transition-timing-function:cubic-bezier(0.22,1,0.36,1)] group-hover:h-[311px]">
            <img src={withBase("assets/Rectangle 9-1.png")} alt="" class="h-full w-full object-cover" />
          </div>
          <div class="mt-[26px] flex items-center justify-between text-ink">
            <span class="text-[18px] font-extralight leading-[21.42px] tracking-[0.72px]">filmmakers</span>
            <span class="text-[18px] font-medium leading-[21.42px] tracking-[0.36px]">Joker</span>
          </div>
        </article>

        <!-- Card 3 -->
        <article class="mx-auto w-full max-w-[433px] group" data-artist-card>
          <div class="h-[230px] w-full overflow-hidden bg-neutral-200 transition-[height] duration-500 [transition-timing-function:cubic-bezier(0.22,1,0.36,1)] group-hover:h-[311px]">
            <img src={withBase("assets/Rectangle 9-2.png")} alt="" class="h-full w-full object-cover" />
          </div>
          <div class="mt-[26px] flex items-center justify-between text-[20px] leading-[23.8px] text-ink">
            <span class="font-extralight">Established</span>
            <span class="font-medium">Tash Sultana</span>
          </div>
        </article>

        <!-- Card 4 -->
        <article class="mx-auto w-full max-w-[433px] group" data-artist-card>
          <div class="h-[230px] w-full overflow-hidden bg-neutral-200 transition-[height] duration-500 [transition-timing-function:cubic-bezier(0.22,1,0.36,1)] group-hover:h-[311px]">
            <img src={withBase("assets/tech-studio1.jpg")} alt="" class="h-full w-full object-cover" />
          </div>
          <div class="mt-[26px] flex items-center justify-between text-[20px] leading-[23.8px] text-ink">
            <span class="font-extralight">Studio</span>
            <span class="font-medium">Control room</span>
          </div>
        </article>
      </div>

      <!-- Cursor-follow “play/mute” control (ties to hero video) -->
      <div class="artist-cursor-badge" data-artist-cursor aria-hidden="true">
        <button
          type="button"
          class="grid h-[69px] w-[93px] place-items-center bg-white font-mono text-[32px] font-medium leading-[32px] text-ink ring-1 ring-black/15"
          data-video-toggle
          tabindex="-1"
          aria-label="Toggle video audio"
        >
          play
        </button>
      </div>
    </section>

    <!-- Ready, Set, Record. (circles rotate in different directions) -->
    <section class="mx-auto max-w-[1512px] px-6 pt-24 pb-12 lg:px-0 lg:pt-40 lg:pb-16" data-rings-section>
      <div class="relative mx-auto h-[520px] w-full max-w-[1512px] lg:h-[520px]">
        <!-- Circles are positioned to match Figma offsets (some overflow left/right) -->
        <div class="pointer-events-none absolute inset-0 overflow-visible" data-rings-layout>
          <!-- left dial -->
          <div class="ring-dial ring-dial--left-outer">
            <div class="ring-scroll h-full w-full" data-ring-scroll data-ring-dir="1">
              <div class="ring-orbit ring-spin-a h-full w-full"></div>
            </div>
          </div>
          <!-- right dial -->
          <div class="ring-dial ring-dial--right-outer">
            <div class="ring-scroll h-full w-full" data-ring-scroll data-ring-dir="-1">
              <div class="ring-orbit ring-spin-d h-full w-full"></div>
            </div>
          </div>
        </div>

        <!-- Copy -->
        <div class="relative z-10 mx-auto flex h-full max-w-[1512px] flex-col items-center justify-center text-center">
          <div class="rings-copy-shield">
            <h2
              class="font-pastiche font-medium text-[clamp(44px,5.5vw,88px)] leading-[clamp(40px,5vw,80px)] tracking-[-1.76px] text-ink"
              aria-label="Ready Set Record"
            >
              Ready Set Record
            </h2>
            <p class="mt-6 max-w-[520px] text-[20px] font-medium leading-[23.8px] text-ink">
              Every room has its own character — and its own story. Come find yours.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Studios (match Figma "home": Studio 1 + Studio 2 blocks) -->
    <section id="studios" class="mx-auto max-w-[1512px] px-6 pb-24 lg:px-[38px] lg:pb-32" aria-label="Studios">
      <div class="space-y-24 lg:space-y-[70px]">
        <!-- Studio 1 -->
        <article
          class="studios-card grid gap-10 lg:grid-cols-[501px_1fr] lg:gap-[34px]"
          data-studio-href={withBase("studio-1/")}
          tabindex="0"
          role="link"
          aria-label="Studio 1"
        >
          <div class="parallax-wrap h-[625px] w-full bg-neutral-200" data-parallax data-parallax-speed="1.0">
            <video
              class="parallax-media h-full w-full object-cover"
              autoplay
              muted
              loop
              playsinline
              preload="metadata"
              poster={withBase("assets/Rectangle 9.png")}
            >
              <source src={withBase("assets/IMG_7367.MOV")} type={videoType(withBase("assets/IMG_7367.MOV"))} />
            </video>
          </div>

          <div class="flex h-full flex-col lg:pl-[34px]">
            <div class="font-mono text-[18px] font-medium tracking-[0.72px] uppercase text-[#CB530E]">STUDIO 1</div>

            <h3 class="mt-5 max-w-[504px] font-pastiche text-[50px] leading-[55px] tracking-[-1px] text-ink">
              Studio number one, or as we call it - Music temple
            </h3>

            <div class="mt-10">
              <div class="font-mono text-[20px] font-medium leading-[23.8px] text-ink">Equipment</div>
              <div class="mt-2 max-w-[322px] font-mono text-[18px] font-light leading-[21.42px] tracking-[0.72px] text-ink">
                Neve 88RS / UAD DSP / Genelec 8341 / SSL Fusion / DBX 160A / Lynx AD/DA / UAD interfaces
              </div>
            </div>

            <div class="mt-auto flex items-end justify-between gap-8 pt-10">
              <div>
                <div class="font-mono text-[20px] font-medium leading-[23.8px] text-ink">Capacity</div>
                <div class="mt-2 font-mono text-[18px] font-light leading-[21.42px] tracking-[0.72px] text-ink">3–5 artists</div>
              </div>

              <div class="studios-cta-wrap h-[49px] w-[249px] shrink-0">
                <PillButton
                  href={withBase("studio-1/")}
                  label="VIEW IN DETAIL"
                  class="studios-follow w-[249px] justify-between"
                  borderColor="#000000"
                  color="#151414"
                />
              </div>
            </div>
          </div>
        </article>

        <div class="studios-sep" aria-hidden="true"></div>

        <!-- Studio 2 -->
        <article
          class="studios-card grid gap-10 lg:grid-cols-[501px_1fr] lg:gap-[34px]"
          data-studio-href={withBase("studio-2/")}
          tabindex="0"
          role="link"
          aria-label="Studio 2"
        >
          <div class="parallax-wrap h-[621px] w-full bg-neutral-200" data-parallax data-parallax-speed="1.0">
            <picture>
              <source srcset={withBase("assets/IMG_7353.heic")} type="image/heic" />
              <img
                src={withBase("assets/IMG_7353.jpg")}
                alt=""
                class="parallax-media h-full w-full object-cover"
                loading="lazy"
                decoding="async"
              />
            </picture>
          </div>

          <div class="flex h-full flex-col lg:pl-[34px]">
            <div class="font-mono text-[18px] font-medium tracking-[0.72px] uppercase text-[#CB530E]">STUDIO 2</div>

            <h3 class="mt-5 max-w-[504px] font-pastiche text-[50px] leading-[55px] tracking-[-1px] text-ink">
              Our second best, number one among competition
            </h3>

            <div class="mt-10">
              <div class="font-mono text-[20px] font-medium leading-[23.8px] text-ink">Equipment</div>
              <div class="mt-2 max-w-[322px] font-mono text-[18px] font-light leading-[21.42px] tracking-[0.72px] text-ink">
                Neve 88RS / UAD DSP / Genelec 8341 / SSL Fusion / DBX 160A / Lynx AD/DA / UAD interfaces
              </div>
            </div>

            <div class="mt-auto flex items-end justify-between gap-8 pt-10">
              <div>
                <div class="font-mono text-[20px] font-medium leading-[23.8px] text-ink">Capacity</div>
                <div class="mt-2 font-mono text-[18px] font-light leading-[21.42px] tracking-[0.72px] text-ink">3–5 artists</div>
              </div>

              <div class="studios-cta-wrap h-[49px] w-[249px] shrink-0">
                <PillButton
                  href={withBase("studio-2/")}
                  label="VIEW IN DETAIL"
                  class="studios-follow w-[249px] justify-between"
                  borderColor="#000000"
                  color="#151414"
                />
              </div>
            </div>
          </div>
        </article>

        <div class="studios-sep" aria-hidden="true"></div>

        <!-- Studio 3 (copy of Studio 2) -->
        <article
          class="studios-card grid gap-10 lg:grid-cols-[501px_1fr] lg:gap-[34px]"
          data-studio-href={withBase("studio-2/")}
          tabindex="0"
          role="link"
          aria-label="Studio 3"
        >
          <div class="parallax-wrap h-[621px] w-full bg-neutral-200" data-parallax data-parallax-speed="1.0">
            <picture>
              <source srcset={withBase("assets/IMG_7353.heic")} type="image/heic" />
              <img
                src={withBase("assets/IMG_7353.jpg")}
                alt=""
                class="parallax-media h-full w-full object-cover"
                loading="lazy"
                decoding="async"
              />
            </picture>
          </div>

          <div class="flex h-full flex-col lg:pl-[34px]">
            <div class="font-mono text-[18px] font-medium tracking-[0.72px] uppercase text-[#CB530E]">STUDIO 3</div>

            <h3 class="mt-5 max-w-[504px] font-pastiche text-[50px] leading-[55px] tracking-[-1px] text-ink">
              Our second best, number one among competition
            </h3>

            <div class="mt-10">
              <div class="font-mono text-[20px] font-medium leading-[23.8px] text-ink">Equipment</div>
              <div class="mt-2 max-w-[322px] font-mono text-[18px] font-light leading-[21.42px] tracking-[0.72px] text-ink">
                Neve 88RS / UAD DSP / Genelec 8341 / SSL Fusion / DBX 160A / Lynx AD/DA / UAD interfaces
              </div>
            </div>

            <div class="mt-auto flex items-end justify-between gap-8 pt-10">
              <div>
                <div class="font-mono text-[20px] font-medium leading-[23.8px] text-ink">Capacity</div>
                <div class="mt-2 font-mono text-[18px] font-light leading-[21.42px] tracking-[0.72px] text-ink">3–5 artists</div>
              </div>

              <div class="studios-cta-wrap h-[49px] w-[249px] shrink-0">
                <PillButton
                  href={withBase("studio-2/")}
                  label="VIEW IN DETAIL"
                  class="studios-follow w-[249px] justify-between"
                  borderColor="#000000"
                  color="#151414"
                />
              </div>
            </div>
          </div>
        </article>
      </div>
    </section>

    <!-- Studio ribbons (Figma y≈4016; two stripes moving opposite directions) -->
    <section aria-label="Studios ribbon" class="w-full px-0 pb-12 lg:pb-16">
      <div class="bg-ink py-[1px] text-white">
        <div class="overflow-hidden">
          <div class="ribbon-track ribbon-left">
            <div class="flex gap-10 whitespace-nowrap px-6 py-[10px] text-[20px] font-medium leading-[23.8px]">
              <span>STUDIO 1</span><span>STUDIO 2</span><span>STUDIO 3</span><span>STUDIO 4</span><span>STUDIO 5</span><span>STUDIO 6</span><span>STUDIO 7</span><span>MIX STUDIO</span>
              <span>STUDIO 1</span><span>STUDIO 2</span><span>STUDIO 3</span><span>STUDIO 4</span><span>STUDIO 5</span><span>STUDIO 6</span><span>STUDIO 7</span><span>MIX STUDIO</span>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-ink py-[1px] text-white">
        <div class="overflow-hidden">
          <div class="ribbon-track ribbon-right">
            <div class="flex gap-10 whitespace-nowrap px-6 py-[10px] text-[20px] font-medium leading-[23.8px]">
              <span>STUDIO 1</span><span>STUDIO 2</span><span>STUDIO 3</span><span>STUDIO 4</span><span>STUDIO 5</span><span>STUDIO 6</span><span>STUDIO 7</span><span>MIX STUDIO</span>
              <span>STUDIO 1</span><span>STUDIO 2</span><span>STUDIO 3</span><span>STUDIO 4</span><span>STUDIO 5</span><span>STUDIO 6</span><span>STUDIO 7</span><span>MIX STUDIO</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Discover all studios button (Figma: 317×49) -->
    <section class="mx-auto max-w-[1512px] px-6 pb-24 lg:px-0 lg:pb-32">
      <div class="flex justify-center">
        <PillButton href="#studios" label="DISCOVER ALL STUDIOS" class="min-w-[317px] justify-between" />
      </div>
    </section>

    <!-- People (anchor target) -->
    <section
      id="people"
      class="mx-auto max-w-[1512px] px-6 pb-20 pt-6 lg:px-0 lg:pt-10"
      data-zoom-group="together"
      data-zoom-axis="y"
      aria-label="People"
    >
      <div class="mx-auto max-w-[1512px] lg:px-[128px]">
        <div class="flex flex-col items-end">
          <h2 class="font-pastiche text-[clamp(56px,7vw,160px)] leading-[clamp(48px,5vw,114px)] text-ink">
            We make it together
          </h2>
          <p class="mt-10 text-[20px] font-medium leading-[23.8px] text-ink">
            Relaxed energy. Serious focus.
          </p>
        </div>

        <div class="mt-10 grid gap-6 lg:mt-[97px] lg:grid-cols-[440px_771px] lg:gap-[74px]" data-together-grid>
          <div class="grid gap-6 lg:gap-[46px]">
            <div class="together-item" data-together-item>
              <div class="together-card group" data-follow-svg="mix-title.svg">
                <img
                  src={withBase("assets/274082823_1471205146649880_25528948957257731_n.jpg")}
                  alt=""
                  class="together-img h-[671px] w-[440px] object-cover"
                  loading="lazy"
                  decoding="async"
                  data-zoom-item
                />
                <span class="together-follow-svg" set:html={mixTitleSvg} aria-hidden="true"></span>
              </div>
              <p class="together-caption mt-6 w-[440px] font-mono text-[20px] font-light leading-[23.8px] text-ink">
                Precision and patience at the console, where tiny moves create massive impact.
              </p>
            </div>

            <div class="together-item" data-together-item>
              <div class="together-card group" data-follow-svg="Lounge-title.svg">
                <img
                  src={withBase("assets/468588580_18342529579181286_562739424918443234_n.jpg")}
                  alt=""
                  class="together-img h-[586px] w-[440px] object-cover"
                  loading="lazy"
                  decoding="async"
                  data-zoom-item
                />
                <span class="together-follow-svg" set:html={loungeTitleSvg} aria-hidden="true"></span>
              </div>
              <p class="together-caption mt-6 w-[440px] font-mono text-[20px] font-light leading-[23.8px] text-ink">
                A comfortable space to relax, discuss sessions, or reset between takes.
              </p>
            </div>
          </div>

          <div class="grid gap-6 lg:gap-[63px]">
            <div class="together-item" data-together-item>
              <div class="together-card group" data-follow-svg="perform-title.svg">
                <img
                  src={withBase("assets/489833225_18358745860181286_4041526710478678309_n.jpg")}
                  alt=""
                  class="together-img h-[543px] w-[771px] object-cover"
                  loading="lazy"
                  decoding="async"
                  data-zoom-item
                />
                <span class="together-follow-svg" set:html={performTitleSvg} aria-hidden="true"></span>
              </div>
              <p class="together-caption mt-6 w-[772px] font-mono text-[20px] font-light leading-[23.8px] text-ink">
                Spaces full of instruments and gear for writing, jamming, and exploring new ideas.
              </p>
            </div>

            <div class="together-item" data-together-item>
              <div class="together-card group" data-follow-svg="share-title.svg">
                <img
                  src={withBase("assets/468588580_18342529579181286_562739424918443234_n.jpg")}
                  alt=""
                  class="together-img h-[696px] w-[772px] object-cover"
                  loading="lazy"
                  decoding="async"
                  data-zoom-item
                />
                <span class="together-follow-svg" set:html={shareTitleSvg} aria-hidden="true"></span>
              </div>
              <p class="together-caption mt-6 w-[772px] font-mono text-[20px] font-light leading-[23.8px] text-ink">
                A listening atelier for early playbacks, critique, and creative conversation
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <SiteFooter />
  </main>

  <!-- Keep anchor targets for menu items without rendering sections -->
  <div id="machines" aria-hidden="true"></div>
  <div id="film" aria-hidden="true"></div>

  <script define:vars={{ BASE_URL }}>
    const toggleBtn = document.querySelector("[data-video-toggle]");
    const videos = Array.from(document.querySelectorAll("video[data-video]"));

    function anyUnmuted() {
      return videos.some((v) => !v.muted);
    }

    function anyPaused() {
      return videos.some((v) => v.paused);
    }

    function syncLabel() {
      if (!toggleBtn) return;
      // Figma shows either "Mute" or "play" depending on state.
      if (anyPaused()) {
        toggleBtn.textContent = "play";
        return;
      }
      // Keep it short for the cursor badge.
      toggleBtn.textContent = anyUnmuted() ? "mute" : "unmute";
    }

    toggleBtn?.addEventListener("click", async () => {
      // If anything is paused, start playback on all.
      if (anyPaused()) {
        await Promise.allSettled(videos.map((v) => v.play()));
        syncLabel();
        return;
      }

      // Toggle muted on all.
      const nextMuted = !videos.some((v) => v.muted);
      videos.forEach((v) => (v.muted = nextMuted));
      syncLabel();
    });

    videos.forEach((v) => {
      v.addEventListener("play", syncLabel, { passive: true });
      v.addEventListener("pause", syncLabel, { passive: true });
      v.addEventListener("volumechange", syncLabel, { passive: true });

      // Hide the poster image once the video is actually playing.
      v.addEventListener(
        "playing",
        () => {
          const poster = document.querySelector(`[data-video-poster="${v.dataset.video}"]`);
          if (poster) poster.style.opacity = "0";
        },
        { passive: true }
      );
    });

    syncLabel();

    // Featured cards: clicking any artist pauses videos (badge becomes "play").
    document.addEventListener(
      "click",
      (e) => {
        const artist = e.target?.closest?.("[data-artist-card]");
        if (!artist) return;
        // Don't treat clicks on actual buttons/links as a “pause everything”.
        if (e.target?.closest?.("a,button,[data-artist-cursor]")) return;

        videos.forEach((v) => v.pause?.());
        syncLabel();
      },
      { passive: true }
    );

    // Featured cards: show the play/mute control as a cursor badge (menu-like).
    const artistCursor = document.querySelector("[data-artist-cursor]");
    const prefersHover = window.matchMedia?.("(hover: hover)")?.matches ?? false;
    const prefersFine = window.matchMedia?.("(pointer: fine)")?.matches ?? false;

    if (artistCursor && prefersHover && prefersFine) {
      let raf = 0;
      let visible = false;
      let targetX = 0;
      let targetY = 0;
      let curX = 0;
      let curY = 0;

      function setVisible(on) {
        visible = !!on;
        artistCursor.toggleAttribute("data-visible", visible);
      }

      function setPos(x, y) {
        // offset so the badge isn't directly under the cursor
        artistCursor.style.transform = `translate3d(${Math.round(x + 18)}px, ${Math.round(y + 10)}px, 0)`;
      }

      function tick() {
        raf = 0;
        if (!visible) return;
        curX += (targetX - curX) * 0.18;
        curY += (targetY - curY) * 0.18;
        setPos(curX, curY);
        raf = requestAnimationFrame(tick);
      }

      function start(e) {
        if (!e) return;
        targetX = e.clientX;
        targetY = e.clientY;
        curX = targetX;
        curY = targetY;
        setPos(curX, curY);
        setVisible(true);
        if (!raf) raf = requestAnimationFrame(tick);
      }

      function stop() {
        setVisible(false);
      }

      document.addEventListener("pointerover", (e) => {
        const card = e.target?.closest?.("[data-artist-card]");
        if (!card) return;
        start(e);
      });

      document.addEventListener("pointerout", (e) => {
        const fromCard = e.target?.closest?.("[data-artist-card]");
        if (!fromCard) return;
        const toCard = e.relatedTarget && e.relatedTarget.closest ? e.relatedTarget.closest("[data-artist-card]") : null;
        if (toCard) return;
        stop();
      });

      document.addEventListener(
        "pointermove",
        (e) => {
          if (!visible) return;
          targetX = e.clientX;
          targetY = e.clientY;
          if (!raf) raf = requestAnimationFrame(tick);
        },
        { passive: true }
      );
    }

    // Studios carousel: drag moves, release snaps one “step” at a time (center big, sides smaller).
    const carousel = document.querySelector("[data-studios-carousel]");
    const track = document.querySelector("[data-studios-track]");
    const slides = Array.from(document.querySelectorAll("[data-studio-card]"));

    if (carousel && track && slides.length) {
      // Default selection: Studio 2 (index 1) when available.
      let index = slides.length > 1 ? 1 : 0;
      let dragging = false;
      let startX = 0;
      let startTranslate = 0;
      let curTranslate = 0;
      let moved = false;
      let preventClick = false;
      const THRESHOLD = 6;

      const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

      function getTranslateX() {
        const m = new DOMMatrix(getComputedStyle(track).transform);
        return m.m41 || 0;
      }

      function setTranslateX(x, animate = true) {
        track.style.transition = animate ? "transform 420ms cubic-bezier(0.22, 1, 0.36, 1)" : "none";
        track.style.transform = `translate3d(${x.toFixed(2)}px, 0, 0)`;
        curTranslate = x;
      }

      function centerTo(i, animate = true) {
        index = clamp(i, 0, slides.length - 1);
        const cRect = carousel.getBoundingClientRect();
        const sRect = slides[index].getBoundingClientRect();
        const carouselCenter = cRect.left + cRect.width / 2;
        const slideCenter = sRect.left + sRect.width / 2;
        const delta = carouselCenter - slideCenter;
        const next = getTranslateX() + delta;
        setTranslateX(next, animate);
        updateSizes();
      }

      function nearestIndex() {
        const cRect = carousel.getBoundingClientRect();
        const carouselCenter = cRect.left + cRect.width / 2;
        let best = 0;
        let bestDist = Infinity;
        for (let i = 0; i < slides.length; i++) {
          const r = slides[i].getBoundingClientRect();
          const cx = r.left + r.width / 2;
          const d = Math.abs(cx - carouselCenter);
          if (d < bestDist) {
            bestDist = d;
            best = i;
          }
        }
        return best;
      }

      function updateSizes() {
        for (let i = 0; i < slides.length; i++) {
          const dist = i - index;
          let pos = "far";
          if (dist === 0) pos = "active";
          else if (dist === -1) pos = "prev";
          else if (dist === 1) pos = "next";
          slides[i].setAttribute("data-pos", pos);
        }
      }

      // Initial center + sizing
      requestAnimationFrame(() => centerTo(index, false));
      window.addEventListener("resize", () => centerTo(index, false), { passive: true });

      carousel.addEventListener(
        "pointerdown",
        (e) => {
          if (e.button !== 0) return;
          if (e.target?.closest?.("a,button")) return;
          dragging = true;
          moved = false;
          startX = e.clientX;
          startTranslate = getTranslateX();
          track.style.transition = "none";
          carousel.classList.add("studios-carousel--dragging");
          try {
            carousel.setPointerCapture(e.pointerId);
          } catch {
            // ignore
          }
        },
        { passive: true }
      );

      carousel.addEventListener(
        "pointermove",
        (e) => {
          if (!dragging) return;
          const dx = e.clientX - startX;
          if (!moved && Math.abs(dx) < THRESHOLD) return;
          moved = true;
          setTranslateX(startTranslate + dx, false);
          e.preventDefault();
        },
        { passive: false }
      );

      function endDrag() {
        if (!dragging) return;
        dragging = false;
        carousel.classList.remove("studios-carousel--dragging");
        const next = nearestIndex();
        centerTo(next, true);
        preventClick = moved;
        setTimeout(() => (preventClick = false), 0);
      }

      carousel.addEventListener("pointerup", endDrag, { passive: true });
      carousel.addEventListener("pointercancel", endDrag, { passive: true });
      carousel.addEventListener("mouseleave", endDrag, { passive: true });

      // If we dragged, don't let the "Learn more" link fire on mouseup.
      carousel.addEventListener(
        "click",
        (e) => {
          if (!preventClick) return;
          const a = e.target?.closest?.("a[href]");
          if (!a) return;
          e.preventDefault();
          e.stopPropagation();
        },
        true
      );

      // Keyboard step
      carousel.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") {
          e.preventDefault();
          centerTo(index - 1, true);
        }
        if (e.key === "ArrowRight") {
          e.preventDefault();
          centerTo(index + 1, true);
        }
      });
    }

    const prefersReducedMotion = window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches ?? false;

    const clamp01 = (v) => Math.min(1, Math.max(0, v));
    const lerp = (a, b, t) => a + (b - a) * t;
    const smoothstep = (t) => t * t * (3 - 2 * t);
    const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);
    const easeInCubic = (t) => t * t * t;

    function fancyScale(t) {
      // Fluid “magazine” feel, but NEVER larger than default size.
      // Tiny → 1.00 (no overshoot, no fade).
      const min = 0.06;
      const max = 1.0;
      if (t <= 0) return min;
      if (t >= 1) return max;
      return lerp(min, max, easeOutCubic(t));
    }

    function applySequentialProgress(items, progress01) {
      const n = items.length;
      if (!n) return;
      const seg = 1 / n;

      for (let i = 0; i < n; i++) {
        const el = items[i];
        const local = clamp01((progress01 - i * seg) / seg);
        const t = smoothstep(local);
        const scale = fancyScale(t);
        // Fluid dynamic: soft parallax, never exceeding scale(1)
        const y = lerp(18, 0, t);
        el.style.opacity = "1";
        el.style.transform = `translate3d(0, ${y.toFixed(2)}px, 0) scale(${scale.toFixed(4)})`;
      }
    }

    function setupVerticalGroup(groupEl) {
      const items = Array.from(groupEl.querySelectorAll("[data-zoom-item]"));
      let ranges = [];
      const groupName = groupEl?.getAttribute?.("data-zoom-group") || "";

      function computeRanges() {
        const vh = window.innerHeight || 1;
        const scrollY = window.scrollY || window.pageYOffset || 0;

        // Each item animates based on its own position in the document, so it
        // won't “appear after you've already passed it”.
        ranges = items.map((el) => {
          const rect = el.getBoundingClientRect();
          const docTop = rect.top + scrollY;
          // Start earlier so the image begins “growing” before it enters the viewport.
          // For "We make it together", start a bit later (closer to the viewport).
          const START_VH = groupName === "together" ? 1.45 : 1.8;
          const END_VH = groupName === "together" ? 0.5 : 0.6;
          const start = docTop - vh * START_VH;
          const end = docTop - vh * END_VH;
          return { start, end: Math.max(end, start + 1) };
        });
      }

      function update() {
        const scrollY = window.scrollY || window.pageYOffset || 0;

        for (let i = 0; i < items.length; i++) {
          const el = items[i];
          const r = ranges[i];
          if (!r) continue;
          const local = clamp01((scrollY - r.start) / (r.end - r.start));
          const t = smoothstep(local);
          const scale = fancyScale(t);
          const y = lerp(18, 0, t);
          el.style.opacity = "1";
          el.style.transform = `translate3d(0, ${y.toFixed(2)}px, 0) scale(${scale.toFixed(4)})`;
        }
      }

      computeRanges();
      update();
      return { update, recompute: computeRanges };
    }

    function setupHorizontalGroup(scrollerEl) {
      const items = Array.from(scrollerEl.querySelectorAll("[data-zoom-item]"));

      function update() {
        const max = scrollerEl.scrollWidth - scrollerEl.clientWidth;
        const h = max > 0 ? clamp01(scrollerEl.scrollLeft / max) : 0;

        // Make the first item animate in as the section comes into view,
        // then horizontal scroll takes over to progress through items.
        const rect = scrollerEl.getBoundingClientRect();
        const vh = window.innerHeight || 1;
        const v = clamp01((vh * 0.9 - rect.top) / (vh * 0.6));
        const seg = items.length ? 1 / items.length : 1;
        const progress01 = clamp01(Math.max(h, v * seg));

        applySequentialProgress(items, progress01);
      }

      let raf = 0;
      scrollerEl.addEventListener(
        "scroll",
        () => {
          if (raf) return;
          raf = requestAnimationFrame(() => {
            raf = 0;
            update();
          });
        },
        { passive: true }
      );

      update();
      return update;
    }

    // Ready / Set / Record: scroll-driven rotation (rings only)
    const ringScrollEls = Array.from(document.querySelectorAll("[data-ring-scroll]"));

    // New behavior: inertial scroll-driven rotation that continues even when the section isn't in view.
    // Much lower sensitivity, but accumulates across page scroll. Feels “physical”.
    let lastScrollY = window.scrollY || window.pageYOffset || 0;
    let vel = 0;
    let angle = 0;
    let ringRaf = 0;

    // “Way less per scroll”: deg per pixel of scroll delta.
    const ROT_PER_PX = 0.12; // 360deg per ~3000px
    const FRICTION = 0.86; // inertia decay
    const SPRING = 0.18; // how quickly velocity responds

    function onScrollForRings() {
      const y = window.scrollY || window.pageYOffset || 0;
      const dy = y - lastScrollY;
      lastScrollY = y;
      // add impulse (scaled down heavily)
      vel += dy * ROT_PER_PX * SPRING;
      if (!ringRaf) ringRaf = requestAnimationFrame(tickRings);
    }

    function tickRings() {
      ringRaf = 0;
      if (prefersReducedMotion || ringScrollEls.length === 0) return;

      // integrate + decay
      angle += vel;
      vel *= FRICTION;

      // apply
      for (const el of ringScrollEls) {
        const dir = Number(el.getAttribute("data-ring-dir") || "1") || 1;
        el.style.setProperty("--scroll-rot", `${angle * dir}deg`);
      }

      // keep ticking while moving
      if (Math.abs(vel) > 0.02) ringRaf = requestAnimationFrame(tickRings);
    }

    if (!prefersReducedMotion) {
      const verticalGroups = Array.from(document.querySelectorAll('[data-zoom-group][data-zoom-axis="y"]')).map(setupVerticalGroup);
      const horizontalUpdaters = Array.from(document.querySelectorAll('[data-zoom-group][data-zoom-axis="x"]')).map(setupHorizontalGroup);

      let raf = 0;
      const updateVertical = () => {
        for (const g of verticalGroups) g.update();
      };

      window.addEventListener(
        "scroll",
        () => {
          if (raf) return;
          raf = requestAnimationFrame(() => {
            raf = 0;
            updateVertical();
          });
        },
        { passive: true }
      );

      window.addEventListener(
        "resize",
        () => {
          for (const g of verticalGroups) g.recompute();
          updateVertical();
          for (const fn of horizontalUpdaters) fn();
        },
        { passive: true }
      );

      updateVertical();
      for (const fn of horizontalUpdaters) fn();
      // Start inertial scroll tracking for rings
      window.addEventListener("scroll", onScrollForRings, { passive: true });
      window.addEventListener("resize", () => (lastScrollY = window.scrollY || window.pageYOffset || 0), { passive: true });
      // kick once so they're initialized
      onScrollForRings();
    } else {
      document.querySelectorAll("[data-zoom-item]").forEach((el) => {
        el.style.transform = "none";
        el.style.opacity = "1";
      });
    }

    // “We make it together”: hover darken + cursor-follow SVG title (desktop only)
    const prefersHoverTogether = window.matchMedia?.("(hover: hover)")?.matches ?? false;
    const prefersFineTogether = window.matchMedia?.("(pointer: fine)")?.matches ?? false;

    if (prefersHoverTogether && prefersFineTogether) {
      const cards = Array.from(document.querySelectorAll("[data-follow-svg]"));

      for (const card of cards) {
        const label = card.querySelector(".together-follow-svg");
        if (!(label instanceof HTMLElement)) continue;

        let raf = 0;
        let x = 0;
        let y = 0;

        const update = () => {
          raf = 0;
          label.style.setProperty("--x", `${x}px`);
          label.style.setProperty("--y", `${y}px`);
        };

        card.addEventListener("pointerenter", () => {
          card.setAttribute("data-following", "true");
        });

        card.addEventListener("pointerleave", () => {
          card.removeAttribute("data-following");
        });

        card.addEventListener(
          "pointermove",
          (e) => {
            const r = card.getBoundingClientRect();
            x = e.clientX - r.left;
            y = e.clientY - r.top;
            if (!raf) raf = requestAnimationFrame(update);
          },
          { passive: true }
        );
      }
    }

    // “We make it together”: captions appear with images
    if (!prefersReducedMotion) {
      const items = Array.from(document.querySelectorAll("[data-together-item]"));
      if (items.length) {
        const obs = new IntersectionObserver(
          (entries) => {
            for (const e of entries) {
              if (e.isIntersecting) {
                e.target.setAttribute("data-inview", "true");
                obs.unobserve(e.target);
              }
            }
          },
          { threshold: 0.2 }
        );
        for (const el of items) obs.observe(el);
      }
    } else {
      document.querySelectorAll("[data-together-item]").forEach((el) => el.setAttribute("data-inview", "true"));
    }

    // Studios: subtle scroll parallax on images
    if (!prefersReducedMotion) {
      const items = Array.from(document.querySelectorAll("[data-parallax]"));
      let raf = 0;

      const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

      function updateParallax() {
        raf = 0;
        const vh = window.innerHeight || 1;
        for (const wrap of items) {
          if (!(wrap instanceof HTMLElement)) continue;
          const media = wrap.querySelector(".parallax-media");
          if (!(media instanceof HTMLElement)) continue;
          const speed = Number(wrap.getAttribute("data-parallax-speed") || "0.12") || 0.12;

          const r = wrap.getBoundingClientRect();
          // progress: -1 (above) .. 1 (below)
          const p = (r.top + r.height / 2 - vh / 2) / (vh / 2);
          // Smooth 0..1 progress through viewport, then center to -1..1
          const progress = (vh - r.top) / (vh + r.height);
          const centered = (progress - 0.5) * 2;
          // Strong parallax, slightly dialed back
          const y = clamp(centered * 170 * speed, -130, 130);
          media.style.setProperty("--py", `${y.toFixed(2)}px`);
        }
      }

      function requestUpdate() {
        if (raf) return;
        raf = requestAnimationFrame(updateParallax);
      }

      updateParallax();
      window.addEventListener("scroll", requestUpdate, { passive: true });
      window.addEventListener("resize", requestUpdate, { passive: true });
    }

    // Studios: whole card navigates + cursor-follow CTA (desktop only for following)
    {
      const cards = Array.from(document.querySelectorAll("[data-studio-href]"));
      for (const card of cards) {
        if (!(card instanceof HTMLElement)) continue;
        const href = card.getAttribute("data-studio-href");
        if (!href) continue;

        card.addEventListener("click", (e) => {
          if (e.defaultPrevented) return;
          const t = e.target;
          if (t instanceof Element && t.closest("a,button")) return;
          window.location.href = href;
        });

        card.addEventListener("keydown", (e) => {
          if (e.key !== "Enter" && e.key !== " ") return;
          e.preventDefault();
          window.location.href = href;
        });
      }

      const prefersHoverStudios = window.matchMedia?.("(hover: hover)")?.matches ?? false;
      const prefersFineStudios = window.matchMedia?.("(pointer: fine)")?.matches ?? false;

      if (prefersHoverStudios && prefersFineStudios) {
        const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

        for (const card of cards) {
          if (!(card instanceof HTMLElement)) continue;
          const btn = card.querySelector(".studios-follow");
          if (!(btn instanceof HTMLElement)) continue;

          let raf = 0;
          let x = 0;
          let y = 0;

          const update = () => {
            raf = 0;
            card.style.setProperty("--sx", `${x}px`);
            card.style.setProperty("--sy", `${y}px`);
          };

          const setFromEvent = (e) => {
            const r = card.getBoundingClientRect();
            // clamp so the pill never fully exits the card
            const pad = 28;
            x = clamp(e.clientX - r.left, pad, r.width - pad);
            y = clamp(e.clientY - r.top, pad, r.height - pad);
            if (!raf) raf = requestAnimationFrame(update);
          };

          card.addEventListener("pointerenter", (e) => {
            card.setAttribute("data-following", "true");
            setFromEvent(e);
          });
          card.addEventListener("pointerleave", () => card.removeAttribute("data-following"));

          card.addEventListener(
            "pointermove",
            (e) => {
              setFromEvent(e);
            },
            { passive: true }
          );
        }
      }
    }
  </script>
</BaseLayout>

